<?php
  //login 
  echo <<<_END
 <html>
  <head>
	<script src = "validate_user.js">
	</script>
	<noscript> Sorry, your browser does not support JavaScript.
	</noscript>
  </head>
  <form id = "log" action = "login.php" method = "post" onsubmit = "return validate_user(log)">
  <pre>
  Username <input type = "text" name = "username" maxlength = '24'>
  Password <input type = "password" name = "password" maxlength = '24'>
  <input type = "submit" value = "CHECK USERNAME">
  </pre></form>
  <form action = "setupuser.php">
  <input type = "submit" value = "NEW USER">
  </form>
</html>
_END;

  if(isset($_POST['username']) && isset($_POST['password'])){
	//initalize variables
	$new_user = '';
	$new_pass = '';
	$query = '';
	$result = '';
	$rows = 0;
	$conn = NULL;
    //validation
	require_once "validate_user.php";
	if(validate_user($_POST['username'], $_POST['password']) != "") {
		echo validate_user($_POST['username'], $_POST['password']);
		return;
	}
    $new_user = $_POST['username'];
    $new_pass = $_POST['password'];
  
    //hash password
	require_once "login_info.php";
    $new_pass = hash('ripemd128', "$salt1$new_pass$salt2");
	$new_pass = substr($new_pass, 0, 20);

	//establish connection to database or fail die
    $conn = new mysqli($hostname, $username, $password, $dbname);
	if($conn->connect_error) die($conn->connect_error);
    else{
		//verify user and secure session
		//query databse to check if it exists
		$query = "SELECT `id` FROM `users` WHERE `username` LIKE '" . $new_user . "' AND `password` LIKE '" . $new_pass . "'";
		$result = $conn->query($query);
		//close resources
		$conn->close();
		$rows = $result->num_rows;
		
		if($rows == 0) die("Incorrect Username/Password.");
		else{
			//theortically no exact same users
			$result->data_seek(0);
			$out = $result->fetch_array(MYSQLI_NUM);
			session_start();
			$_SESSION['id'] = hash('ripemd128', $out[0]);
			$_SESSION['check'] = hash('ripemd128', $_SERVER['REMOTE_ADDR'] . $_SERVER['HTTP_USER_AGENT']);
			//echo $_SESSION['id'];

			header('Location: upload.php');
		}
		
	}
  }
?>