<?php
	function logout(){
		$_SESSION = array();
		session_destroy();
		header('Location: login.php');
	}

	//starting form if login
	session_start();
	//prevent session fixing 
	if(!isset($_SESSION['prevent']){
		session_regenerate_id();
		$_SESSION['prevent'] = 1;
	}
	if(!isset($_SESSION['id'])){
		die("Please Login");
	} else if(!authenitcate($_SESSION['id'])){
		die("Incorrect Login");
	} else if($_SESSION['check'] != hash('ripemd128', $_SERVER['REMOTE_ADDR'] . $_SERVER['HTTP_USER_AGENT'])){
		logout();
		die("Please relogin");
	}
	else {
	//Form itself
	echo <<<_END
		<html><head><title>PHP Form Upload</title></head><body>
		<form method = 'post' action='upload.php' enctype='multipart/form-data'>
			Upload a file to be checked: 
			<input type='file' name='filename' size='10'>
			<input type='submit' value='Upload'>
		</form>
		<form method = 'post' action = "upload.php" >
		<input type = "submit" name = 'submit' value = "LOGOUT">
        </form>
_END;
	}

	//logout if button is pressed
	if(isset($_POST['submit'])) 
		logout();


	if ($_FILES && isset($_SESSION['id']))
	{
		$signature = '';	
		$query = '';
		$result = '';
		$rows = 0;
		$conn = NULL;
		$hostname = '';
		$username = '';
		$password = '';
		$dbname = '';
		if($_FILES['filename']['error'] > 0 && $_FILES['filename']['error'] <= 8) 
			die ("Choose a File");
		
		//read file by bytes
		move_uploaded_file($_FILES['filename']['tmp_name'], $_FILES['filename']['name']);
		$signature = openfile($_FILES['filename']['name']);
		$signature = substr($signature, 0, 20);

		//database connection
		require_once "login_info.php";
		$conn = new mysqli($hostname, $username, $password, $dbname);
		if($conn->connect_error) die($conn->connect_error);

		//query databse to check if it exists
		$query = "SELECT `file_name` FROM `infected` WHERE `signature` LIKE '" . $signature . "'";
		$result = $conn->query($query);
		//close connection after use
		$conn->close();

		$rows = $result->num_rows;
		if($rows == 0) die("File is not a malware");
		else{
			//first and only malware with signature
			$result->data_seek(0);
			$out = $result->fetch_array(MYSQLI_NUM);
			echo "File is a malware. Name: $out[0]";
			
		}
	} 
	

	function openfile($filename){
		$fh = '';
		$text = '';
		//validates if the file is openable
		$fh = fopen($filename, 'rb') or die ("File does not exist or you lack permission to open it");
		$text = fread($fh, 20);
		$text = hash('ripemd128', $text);
		fclose($fh);
		return $text;
	}

	//authenticate the user 
	function authenitcate($id){	
		$query = '';
		$result = '';
		$rows = 0;
		$conn = NULL;
		$hostname = '';
		$username = '';
		$password = '';
		$dbname = '';
		$out = '';
		//connect to db
		require_once "login_info.php";
		$conn = new mysqli($hostname, $username, $password, $dbname);
		if($conn->connect_error) die($conn->connect_error);
		//verify user by checking for all hashed id to find a similar one
		$query = "SELECT `id` FROM `users`";
		$result = $conn->query($query);
		$rows = $result->num_rows;
		//close connection
		$conn->close();
		if($rows == 0) die("Incorrect Username/Password.");
		else{
			//iterate through all possible users hashes and check if they belong to anyone
			for($i = 0; $i < $rows; $i++){
				$result->data_seek($i);
				$out = $result->fetch_array(MYSQLI_NUM);
				if($id == hash('ripemd128', $out[0])){
					return true;
				} 
			}
			return false;
		}
	}

?>