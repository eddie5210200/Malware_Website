<?php
	
	function logout(){
		$_SESSION = array();
		session_destroy();
		header('Location: login_admin.php');
	}

	//starting form if login
	session_start();
	if(!isset($_SESSION['prevent']){
		session_regenerate_id();
		$_SESSION['prevent'] = 1;
	}
	if(!isset($_SESSION['id'])){
		die("Please Login");
	} else if(!authenitcate($_SESSION['id'])){
		die("Incorrect Login");
	} else if($_SESSION['check'] != hash('ripemd128', $_SERVER['REMOTE_ADDR'] . $_SERVER['HTTP_USER_AGENT'])){
		logout();
		die("Please relogin");
	}
	else {
  //form
  echo <<<_END
  <form method='post' action='upload_admin.php' enctype='multipart/form-data'>
  <pre>
  Upload Infected Files
  Name <input type = "text" name = "file_name" maxlength = '24'>
  File <input type = "file" name = "signature" size='10'>
  <input type = "submit" value = "SUBMIT">
  </pre></form>

  <form method = 'post' action = "upload_admin.php" >
  <input type = "submit" name = 'submit' value = "LOGOUT">
  </form>
_END;
	}
	//logout if button is pressed
	if(isset($_POST['submit'])) 
		logout();


  //add filename and signature to table
	if(isset($_POST['file_name']) && $_FILES && authenitcate($_SESSION['id'])){
		$hostname = '';
		$username = '';
		$password = '';
		$dbname = '';
		$name = '';
		$query = '';
		$result = '';
		$rows = 0;
		$conn = NULL;
		$signature = '';
		//validate name and read signature of file
		if($_POST['file_name'] == NULL) 
			die ("Add File Name");
		if($_FILES['signature']['error'] > 0 && $_FILES['signature']['error'] <= 8) 
			die ("Choose a File");
		if(preg_match('/[^a-zA-Z0-9\_\-\ ]/', $_POST['file_name'])){
			die("Filename can only contain letters, numbers, dash, underscore or space");
		}

		$name = sanitizeString($_POST['file_name']);
		if($_FILES){
			move_uploaded_file($_FILES['signature']['tmp_name'], $_FILES['signature']['name']);
			$signature = openfile($_FILES['signature']['name']);
		} else die("No File");

		//login
		require_once "login_info.php";
		$conn = new mysqli($hostname, $username, $password, $dbname);
		if($conn->connect_error) die($conn->connect_error);
    
		//query db
		//check for duplicates names
		$query = "SELECT * FROM `infected` WHERE `file_name` LIKE '" . $name . "'";
		$result = $conn->query($query);
		//close connection
		$conn->close();

		$rows = $result->num_rows;
		//no duplicate names
		if($rows != 0) {
			die("This is a duplicate malware name");
		}
		//add if no duplicates exist
		$query = "INSERT INTO `infected` (`file_name`, `signature`) VALUES ('" . $name . "', '" . $signature . "')";
		$result = $conn->real_escape_string($query);
		if(!$result) die ("failed - $signature");
		echo "Added " . $name . " Successfully";
		
	}

	//returns the signature of a file
	function openfile($filename){
		$fh = '';
		$text = '';
		//validates if the file is openable
		$fh = fopen($filename, 'rb') or die ("File does not exist or you lack permission to open it");
		$text = fread($fh, 20);
		$text = hash('ripemd128', $text);
		fclose($fh);
		return $text;
	}

	//authenticate the user 
	function authenitcate($id){
		$conn = NULL;
		$hostname = '';
		$username = '';
		$password = '';
		$dbname = '';
		//connect to db
		require_once "login_info.php";
		$conn = new mysqli($hostname, $username, $password, $dbname);
		if($conn->connect_error) die($conn->connect_error);
		//verify admin account
		if($_SESSION['id'] == hash('ripemd128', "$username$password")){
			return true;
		} return false;
		
	}

	function sanitizeString($var) {
	$var = stripslashes($var);
	$var = strip_tags($var);
	$var = htmlentities($var);
	return $var;
  }
?>