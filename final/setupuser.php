<?php
  //login 
  echo <<<_END
  <html>
  	<head>
	<script src = "validate_user.js">
	</script>
	<noscript> Sorry, your browser does not support JavaScript.
	</noscript>
	</head>
	<body>
	<form id = "reg" action = "setupuser.php" method = "post" onsubmit = "return validate(reg)">
	<pre>
	Welcome New User! Input your username and password

	Email <input type = "email" name = "email" maxlength = '48'>
	Username <input type = "text" name = "username" maxlength = '24'>
	Password <input type = "password" name = "password" maxlength = '24'>
	<input type = "submit" value = "ADD USER">
  </pre></form>
  </body>
  </html>
_END;

  if(isset($_POST['email']) && isset($_POST['username']) && isset($_POST['password'])){
	//initalize variables
	$new_user = '';
	$new_pass = '';
	$query = '';
	$result = '';
	$rows = 0;
	$conn = NULL;
	//validate - if fail, quit
	require_once "validate_user.php";
	if(validate($_POST['username'], $_POST['password'], $_POST['email']) != "") {
		echo validate($_POST['username'], $_POST['password'], $_POST['email']);
		return;
	}
    //connect to server
    require_once "login_info.php";
    $conn = new mysqli($hostname, $username, $password, $dbname);
    if($conn->connect_error) die($conn->connect_error);
    
    //sanitize text inputs
    $new_user = sanitizeString($_POST['username']);
    $new_pass = sanitizeString($_POST['password']);
	$new_email = sanitizeString($_POST['email']);
    $new_pass = hash('ripemd128', "$salt1$new_pass$salt2");
	$new_pass = substr($new_pass, 0, 20);

    
    //query database with new user or error if id is duplicate
    $query = "INSERT INTO `users` (`username`, `password`, `email`) VALUES('" . $new_user ."', '" . $new_pass ."' , '" . $new_email ."')";  
	echo $query;
    $result = $conn->real_escape_string($query); 

	//close connection
	$conn->close();
	echo "User: " . $new_user . "added successfully";
	header('Location: login.php');
  }
  function sanitizeString($var) {
	$var = stripslashes($var);
	$var = strip_tags($var);
	$var = htmlentities($var);
	return $var;
  }

?>